var k=Object.defineProperty;var A=(i,e,t)=>e in i?k(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var u=(i,e,t)=>A(i,typeof e!="symbol"?e+"":e,t);import{P as R,Q as g}from"./scheduler.C7Wo8M4i.js";import{n as T}from"./stores.2WuGYSmf.js";import{w}from"./index._5LYSXs0.js";import{b as C,a as x}from"./entry.CEfYAMar.js";const b=encodeURIComponent,l=/^[\u0009\u0020-\u007e\u0080-\u00ff]+$/;function _(i,e,t){let s=t||{},o=s.encode||b;if(typeof o!="function")throw new TypeError("option encode is invalid");if(!l.test(i))throw new TypeError("argument name is invalid");let r=o(e);if(r&&!l.test(r))throw new TypeError("argument val is invalid");let a=i+"="+r;if(s.maxAge!=null){let n=s.maxAge-0;if(isNaN(n)||!isFinite(n))throw new TypeError("option maxAge is invalid");a+="; Max-Age="+Math.floor(n)}if(s.domain){if(!l.test(s.domain))throw new TypeError("option domain is invalid");a+="; Domain="+s.domain}if(s.path){if(!l.test(s.path))throw new TypeError("option path is invalid");a+="; Path="+s.path}if(s.expires){if(typeof s.expires.toUTCString!="function")throw new TypeError("option expires is invalid");a+="; Expires="+s.expires.toUTCString()}if(s.httpOnly&&(a+="; HttpOnly"),s.secure&&(a+="; Secure"),s.sameSite)switch(typeof s.sameSite=="string"?s.sameSite.toLowerCase():s.sameSite){case!0:a+="; SameSite=Strict";break;case"lax":a+="; SameSite=Lax";break;case"strict":a+="; SameSite=Strict";break;case"none":a+="; SameSite=None";break;default:throw new TypeError("option sameSite is invalid")}return a}const M={clearArray:!1,clearOnNavigate:!0,clearAfterMs:0,flashCookieOptions:{path:"/",maxAge:120,httpOnly:!1,sameSite:"strict"}};function F(i,e){return{...i,...e,flashCookieOptions:{...i.flashCookieOptions,...e==null?void 0:e.flashCookieOptions}}}class d{constructor(e,t){u(this,"options");u(this,"_message");u(this,"_flashTimeout",0);this.options=t??M,this._message={subscribe:e.subscribe,set:(s,o)=>e.update(r=>this.update(r,s,(o==null?void 0:o.concatenateArray)??!1)),update:(s,o)=>e.update(r=>this.update(r,s(r),(o==null?void 0:o.concatenateArray)??!1))}}get message(){return this._message}get flashTimeout(){return this._flashTimeout}update(e,t,s=!1){return this._flashTimeout&&clearTimeout(this.flashTimeout),s&&Array.isArray(t)&&Array.isArray(e)?e.length>0&&t.length>0&&e[e.length-1]===t[t.length-1]?e:e.concat(t):(t!==void 0&&this.options.clearAfterMs&&(this._flashTimeout=setTimeout(()=>{this.message.set(void 0)},this.options.clearAfterMs)),t)}}class O{constructor(){u(this,"routes",new Map);u(this,"messageStore");this.messageStore=w(),this.routes.set("",new d(this.messageStore)),R(()=>{for(const e of this.routes.values())clearTimeout(e.flashTimeout)})}get defaultRoute(){return this.routes.get("")}has(e){return this.routes.has(e)}getFlashMessage(e){return e?this.routes.has(e)?this.routes.get(e):this.getClosestRoute(e):this.defaultRoute}getClosestRoute(e){const t=Array.from(this.routes.keys()).filter(o=>e.includes(o));if(!t.length)return this.defaultRoute;const s=t.reduce((o,r)=>r.length>o.length?r:o);return this.routes.get(s)}createRoute(e,t,s){const o=this.getClosestRoute(e),r=new d(this.messageStore,F(o.options,s));return r.message.set(t),this.routes.set(e,r),r}}const f="flash",p=new WeakMap;function c(i,e){let t=p.get(i);return t||(t=new O,p.set(i,t),t.getFlashMessage(g(i).route.id).message.set(e),v(i)),t}function v(i){i.subscribe(e=>{const t=S();if(t!==void 0){const s=c(i).getFlashMessage(e.route.id);s.message.set(t,{concatenateArray:!s.options.clearArray}),y(s.options.flashCookieOptions)}}),C(e=>{var s,o;const t=(s=e==null?void 0:e.to)==null?void 0:s.route.id;if(t){const r=c(i).getFlashMessage(t);r.options.clearOnNavigate&&((o=e.from)==null?void 0:o.route.id)!=t&&r.message.set(void 0)}}),x(()=>{const e=S();if(e!==void 0){const t=c(i).getFlashMessage(g(i).route.id);t.message.set(e,{concatenateArray:!t.options.clearArray}),y(t.options.flashCookieOptions)}})}function E(i,e){const t=g(i),s=c(i,t.data.flash);function o(){const m=s.routes.get(h());return m||(e?r():s.getClosestRoute(h()))}function r(){return s.createRoute(h(),n(),e)}const a={store:i,route:t.route.id,initialdata:t.data.flash,navigating:T};function n(){return a.initialdata}function h(){return a.route??""}return o()}function H(i,e){return E(i,e).message}function y(i){document.cookie=_(f,"",{...i,maxAge:0})}function S(){const i=document.cookie;if(!i||!i.includes(f+"="))return;function e(s){const o={};return s?s.split(";").map(r=>r.split("=")).reduce((r,a)=>(r[decodeURIComponent(a[0].trim())]=decodeURIComponent(a[1].trim()),r),o):o}const t=e(i);if(t[f])try{return JSON.parse(t[f])}catch{}}export{H as g};
