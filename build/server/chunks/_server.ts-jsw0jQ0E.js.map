{"version":3,"file":"_server.ts-jsw0jQ0E.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/admin/download_database/_server.ts.js"],"sourcesContent":["import { p as prisma } from \"../../../../../chunks/prisma.js\";\nconst GET = async (event) => {\n  const user = event.locals.user;\n  if (!user?.id) {\n    return new Response(JSON.stringify({ ok: false, error: \"Not authenticated\" }), { status: 401 });\n  }\n  const prismaUser = await prisma.user.findUnique({\n    where: { id: user.id }\n  });\n  if (!prismaUser?.root) {\n    return new Response(JSON.stringify({ ok: false, error: \"Insufficient permissions\" }), { status: 403 });\n  }\n  try {\n    const users = await prisma.user.findMany();\n    const slots = await prisma.slot.findMany();\n    const sessions = await prisma.session.findMany();\n    const contributions = await prisma.contribution.findMany();\n    const backup = {\n      timestamp: (/* @__PURE__ */ new Date()).toISOString(),\n      users,\n      slots,\n      sessions,\n      contributions\n    };\n    const sql = generateSQL(backup);\n    return new Response(sql, {\n      status: 200,\n      headers: {\n        \"Content-Type\": \"application/sql\",\n        \"Content-Disposition\": `attachment; filename=\"grinp_backup_${(/* @__PURE__ */ new Date()).toISOString().split(\"T\")[0]}.sql\"`\n      }\n    });\n  } catch (error) {\n    console.error(error);\n    return new Response(JSON.stringify({ ok: false, error: error instanceof Error ? error.message : \"Unknown error\" }), { status: 400 });\n  }\n};\nfunction generateSQL(backup) {\n  let sql = `-- Grinp TDB Backup\n-- Generated: ${backup.timestamp}\n\n`;\n  sql += `-- Users\n`;\n  backup.users.forEach((user) => {\n    sql += `INSERT INTO \"User\" (id, churros_uid, first_name, last_name, email, password, root, instructor, cotisant_as, cotisant_grinp) `;\n    sql += `VALUES ('${escapeSql(user.id)}', ${user.churros_uid ? `'${escapeSql(user.churros_uid)}'` : \"NULL\"}, '${escapeSql(user.first_name)}', '${escapeSql(user.last_name)}', '${escapeSql(user.email)}', ${user.password ? `'${escapeSql(user.password)}'` : \"NULL\"}, ${user.root}, ${user.instructor}, ${user.cotisant_as}, ${user.cotisant_grinp});\n`;\n  });\n  sql += `\n-- Slots\n`;\n  backup.slots.forEach((slot) => {\n    sql += `INSERT INTO \"Slot\" (id, name, description, starts_at, ends_at, capacity, owner_id) `;\n    sql += `VALUES ('${escapeSql(slot.id)}', ${slot.name ? `'${escapeSql(slot.name)}'` : \"NULL\"}, ${slot.description ? `'${escapeSql(slot.description)}'` : \"NULL\"}, '${slot.starts_at}', '${slot.ends_at}', ${slot.capacity}, '${escapeSql(slot.owner_id)}');\n`;\n  });\n  sql += `\n-- Sessions\n`;\n  backup.sessions.forEach((session) => {\n    sql += `INSERT INTO \"Session\" (id, \"userId\", \"expiresAt\") VALUES ('${escapeSql(session.id)}', '${escapeSql(session.userId)}', '${session.expiresAt}');\n`;\n  });\n  sql += `\n-- Contributions\n`;\n  backup.contributions.forEach((contrib) => {\n    sql += `INSERT INTO \"Contribution\" (id, type, \"startDate\", \"expirationDate\", amount, \"userId\") `;\n    sql += `VALUES ('${escapeSql(contrib.id)}', '${escapeSql(contrib.type)}', '${contrib.startDate}', '${contrib.expirationDate}', ${contrib.amount}, '${escapeSql(contrib.userId)}');\n`;\n  });\n  return sql;\n}\nfunction escapeSql(str) {\n  return str.replace(/'/g, \"''\");\n}\nexport {\n  GET\n};\n"],"names":[],"mappings":"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"}